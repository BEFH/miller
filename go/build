#!/bin/bash

verbose=""
do_wips="false"
if [ "$1" = "-v" ]; then
  shift
  set -x
  verbose="-v"
fi
if [ "$1" = "-x" ]; then
  shift
  do_wips="true"
fi

set -euo pipefail

echo ================================================================
echo BUILD
go build mlr.go
echo Compile OK
echo

# During the C-to-Go port I like to have ../c/mlr and ./mlrgo and have symlinks
# to them from my ~/lbin. Hence the duplicate name here.
cp mlr mlrgo

echo ================================================================
echo UNIT TESTS
go test ./...
echo

echo ================================================================
echo REGRESSION TESTS v2
echo
mlr regtest $verbose reg-test/cases
mlr regtest $verbose reg-test/cases-pending-windows
if [ "$do_wips" = "true" ]; then
  mlr regtest $verbose reg-test/cases-pending-go-port
fi
echo

echo ================================================================
echo REGRESSION TESTS v1
echo
./reg-test/run -n $verbose
if [ "$do_wips" = "true" ]; then
  ./reg-test/run -o $verbose
fi
